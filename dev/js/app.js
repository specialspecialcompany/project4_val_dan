const zomatoAPI = {};

// API url
zomatoAPI.url = "https://developers.zomato.com/api/v2.1/search";

//API Key
zomatoAPI.key = "6bff49b5a9a15a9b920996759741d5b1";

//Initiate a key to hold the returned results
zomatoAPI.results = [];

//User keywords
zomatoAPI.userKeywords = "coffee";


//Method to change number of results to display
zomatoAPI.changeNumberOfResults = newNumber => {
  zomatoAPI.numberOfResults = newNumber;
};

//User coordinates, defaults to HackerYou -
zomatoAPI.userCoordinates = {
  lat: 43.6482644,
  lon: -79.3978587
};

//Method to change user coordinates
zomatoAPI.setCoordinates = (lat, lon) => {
  zomatoAPI.userCoordinates.lat = lat;
  zomatoAPI.userCoordinates.lat = lon;
};

//Search radius default value in Meters
zomatoAPI.radius = 10.00;

//Method to set search radius in Meters
zomatoAPI.setRadius = radius => {
  zomatoAPI.radius = radius;
};

//GET results from Zomato API
zomatoAPI.getResults = () => {
  $.ajax({
    method: "GET",
    crossDomain: true,
    url: zomatoAPI.url,
    dataType: "json",
    async: true,
    data: {
      q: zomatoAPI.userKeywords,
      lat: zomatoAPI.userCoordinates.lat,
      lon: zomatoAPI.userCoordinates.lon,
      radius: zomatoAPI.radius,
      sort: "real_distance"
    },
    headers: {
      "user-key": zomatoAPI.key
      }
   }).then(res => {
      zomatoAPI.results = res.restaurants;
      console.log(zomatoAPI.results)
   });

};

zomatoAPI.normalizeResults = () => {
   let flatArr = zomatoAPI.results;
   let normalizedArr = [];
   flatArr = flatArr.map(item => item.restaurant).forEach(item => normalizedArr.push([item.name, item.location.latitude, item.location.longitude, item.location.address, item.cuisines, item.price_range, item.thumb, item.featured_image, item.url]));
   console.log(normalizedArr);
};

//MAP OBJECT
// Create app namespace to hold all methods
const maps = {};
// Static locations for markers on map
maps.locations = [
  ["HackerYou", 43.6482644, -79.4000474],
  ["HackerYou", 43.6482644, -79.4000474],
  ["Fresh on Spadina", 43.648264, -79.395689],
  ["Dollarama", 43.648264, -79.398544],
  ["Loblaws", 43.648264, -79.400516]
];
maps.startLocation = {
  lat: 43.6482644,
  lng: -79.4000474
};
// var cityCircle = new google.maps.Circle({
//   strokeColor: "#FF0000",
//   strokeOpacity: 0.8,
//   strokeWeight: 2,
//   fillColor: "#FF0000",
//   fillOpacity: 0.35,
//   map: map,
//   center: citymap[city].center,
//   radius: Math.sqrt(citymap[city].population) * 100
// });
// Get data from ZOmato API and push into locations array

maps.getMapData = (...array) => {
  map.locations.push([]);
};

// Display Google Map on screen, run a forEach method against each location in the Locations array
maps.displayMap = function() {
  let map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: maps.startLocation.lat, lng: maps.startLocation.lng },
    zoom: 15
  });
  maps.setMarkers(map);
};

//Create markers on Google Maps based on the Locations
maps.setMarkers = map => {
  for (let i = 0; i < maps.locations.length; i++) {
    const location = maps.locations[i];
    const marker = new google.maps.Marker({
      position: { lat: location[1], lng: location[2] },
      map: map,
      title: location[0]
    });
    // Add add click listener for each marker added to map

    maps.eventListener(map, marker);
  }
  maps.drawRadiusMarker(map);
};

maps.drawRadiusMarker = map => {
  let hyCircle = new google.maps.Circle({
    strokeColor: "#D11F26",
    strokeOpacity: 0.5,
    strokeWeight: 2,
    fillColor: "#D11F26",
    fillOpacity: 0.2,
    map: map,
    center: { lat: maps.startLocation.lat, lng: maps.startLocation.lng },
    radius: zomatoAPI.radius
  });
};

// map.markerContent = (title, subtype, description) => {
//   return `<h1>${title}</h1>
//     <h3>${subtype}</h3>
//     <p>${description}</p>
//   `;
// };

maps.eventListener = (map, marker) => {
  let infowindow = new google.maps.InfoWindow({
    content: `<h1>hi!</h1>
              <h2> I'm a sub-heading </h2>
              <p> Lorem ipsum, dolor sit amet consectetur adipisicing elit. Nostrum quis cupiditate corporis veritatis culpa nemo reiciendis numquam delectus quia aperiam, dolore beatae neque cum consequuntur maxime praesentium voluptatum dolor sed!</p>
    `
  });
  marker.addListener("click", function() {
    infowindow.open(map, marker);
  });
};

// Start app
map.init = () => {
    setTimeout(function() {
       map.displayMap()
      }, 500);
}

$(function () {
    map.init();
    zomatoAPI.getResults();
});

